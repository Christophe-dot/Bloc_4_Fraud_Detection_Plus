name: Automatic testing and deployment

on:
  push:
    branches:
      - main

jobs:

  implementing_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"  

      - name: Install dependencies
        run: |
          pip install --upgrade pip 
          pip install pytest httpx psycopg2-binary python-dotenv
          pip install boto3 botocore 
          pip install mlflow scikit-learn pandas numpy 
          pip install -r "requirements.txt" 

      - name: Debug environment
        run: | 
          echo "üîç Environment check:"
          echo "MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI != '' && 'SET' || 'NOT SET' }}" 
          echo "HF_TOKEN set: ${{ secrets.HF_TOKEN != '' }}" 
          echo "AWS_ACCESS_KEY_ID set: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}" 
          echo "AWS_SECRET_ACCESS_KEY set: ${{ secrets.AWS_SECRET_ACCESS_KEY != '' }}"
          echo "AWS_DEFAULT_REGION set: ${{ secrets.AWS_DEFAULT_REGION != '' }}" 
          python -c "import mlflow; print(f'MLflow version: {mlflow.__version__}')" 
          python -c "import boto3; print(f'Boto3 version: {boto3.__version__}')" 
          python -c "import sys; print(f'Python: {sys.version}')"

      - name: Generate timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Run tests
        continue-on-error: false 
        run: |
          # Export ALL environment variables
          export MLFLOW_TRACKING_URI="${{ secrets.MLFLOW_TRACKING_URI }}"
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" 
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" 
          export AWS_DEFAULT_REGION="${{ secrets.AWS_DEFAULT_REGION }}" 

          # Run tests
          pytest "tests/" \
            # --html="unit_test_report_${{ steps.timestamp.outputs.date }}.html" \
            # --self-contained-html \
            -v -s \
            --tb=short \
            --junit-xml="unit_test_results_${{ steps.timestamp.outputs.date }}.xml" || true

  # deployment:
  #   needs: implementing_tests #‚Üê change with your pref 
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Install dependencies for Streamlit #‚Üê change with your pref 
  #       run: pip install huggingface_hub

  #     - name: Deploy Streamlit to Hugging Face Spaces #‚Üê change with your pref 
  #       run: |
  #         python -c "
  #         from huggingface_hub import HfApi
  #         api = HfApi(token='${{ secrets.HF_TOKEN }}')
  #         api.upload_folder(
  #             folder_path='./Bloc4 - Final project/Projet/Architecture/App/Dockers/streamlit', 
  #             repo_id='DavidRambeau/bloc3_Streamlit',
  #             repo_type='space'
  #         )
  #         "
